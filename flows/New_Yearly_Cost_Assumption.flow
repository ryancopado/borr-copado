<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>49.0</apiVersion>
    <assignments>
        <name>Assign_YCA_Records</name>
        <label>Assign YCA Records</label>
        <locationX>580</locationX>
        <locationY>480</locationY>
        <assignmentItems>
            <assignToReference>YCA_RecordsToUpdate</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>LoopVariable</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Deactivate_Related_YCA_Records</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Inactive</name>
        <label>Inactive</label>
        <locationX>467</locationX>
        <locationY>444</locationY>
        <assignmentItems>
            <assignToReference>LoopVariable.Active__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>LoopVariable.Active_Yearly_Cost_Assumption__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue></stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>LoopVariable.Date_Deactivated__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Flow.CurrentDate</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Assign_YCA_Records</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>New_Assumed_Value</name>
        <label>New Assumed Value</label>
        <locationX>807</locationX>
        <locationY>533</locationY>
        <assignmentItems>
            <assignToReference>LoopVariable_Opportunity.Assumed_Non_IX_Sales_W__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_New_YCA_Record.Non_IX_Dev_W__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>LoopVariable_Opportunity.MIPA_Contract_Value_Calculation__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Calculate_New_MIPA_Contract_Value</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Opportunities_to_Update</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Opportunities_to_Update</name>
        <label>Opportunities to Update</label>
        <locationX>954</locationX>
        <locationY>513</locationY>
        <assignmentItems>
            <assignToReference>Opportunity_RecordsToUpdate</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>LoopVariable_Opportunity</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Affected_Opportunities</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Opportunity_Records_Found</name>
        <label>Opportunity Records Found</label>
        <locationX>711</locationX>
        <locationY>184</locationY>
        <defaultConnector>
            <targetReference>Deactivate</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>OpportunityRecords_Found</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Affected_Opportunities</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_Affected_Opportunities</targetReference>
            </connector>
            <label>Opportunity Records Found</label>
        </rules>
    </decisions>
    <decisions>
        <name>YCA_Records_Found</name>
        <label>YCA Records Found</label>
        <locationX>286</locationX>
        <locationY>182</locationY>
        <defaultConnector>
            <targetReference>Opportunity_Records_Found</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Records_Found</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Find_Matching_YCA_Records</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Deactivate_Related_YCA_Records</targetReference>
            </connector>
            <label>Records Found</label>
        </rules>
    </decisions>
    <formulas>
        <name>Calculate_New_MIPA_Contract_Value</name>
        <dataType>Currency</dataType>
        <expression>IF(
 NOT( ISBLANK( {!LoopVariable_Opportunity.MIPAContractValueOverride__c} ) ),
{!LoopVariable_Opportunity.MIPAContractValueOverride__c} , 
 IF(
  NOT( ISBLANK( {!LoopVariable_Opportunity.Acceptedinto7C__c} )),
  {!LoopVariable_Opportunity.Post7CContractAmount__c} ,
  IF(
   {!LoopVariable_Opportunity.TurnkeyValuation__c} &gt; 0,
   {!LoopVariable_Opportunity.TurnkeyValuation__c} - {!LoopVariable_Opportunity.EPCRevenue__c} ,
   IF(
    {!LoopVariable_Opportunity.Record_Type_Name__c} = &quot;Standalone Storage&quot;,
    ({!Get_New_YCA_Record.Non_IX_Dev_W__c} * {!LoopVariable_Opportunity.ESS_Energy_kWh__c} * 1000) + {!LoopVariable_Opportunity.InterconnectionUpgradeCost__c} ,
   ( {!Get_New_YCA_Record.Non_IX_Dev_W__c} * {!LoopVariable_Opportunity.Original_Contract_System_Size__c} ) + {!LoopVariable_Opportunity.InterconnectionUpgradeCost__c}
    )
   )
  )
 )</expression>
        <scale>2</scale>
    </formulas>
    <formulas>
        <name>New_YCA_Effective_End_Date</name>
        <dataType>Date</dataType>
        <expression>DATE( VALUE( {!Get_New_YCA_Record.Year__c} ), 12 , 31 )</expression>
    </formulas>
    <formulas>
        <name>New_YCA_Effective_Start_Date</name>
        <dataType>Date</dataType>
        <expression>DATE( VALUE( {!Get_New_YCA_Record.Year__c} ), 01 , 01 )</expression>
    </formulas>
    <formulas>
        <name>New_YCA_Name</name>
        <dataType>String</dataType>
        <expression>{!Get_New_YCA_Record.Year__c} &amp; &quot; &quot; &amp; {!Get_New_YCA_Record.Cost_Assumption__r.Name}</expression>
    </formulas>
    <interviewLabel>New Yearly Cost Assumption {!$Flow.CurrentDateTime}</interviewLabel>
    <label>New Yearly Cost Assumption</label>
    <loops>
        <name>Deactivate_Related_YCA_Records</name>
        <label>Deactivate Related YCA Records</label>
        <locationX>512</locationX>
        <locationY>278</locationY>
        <assignNextValueToReference>LoopVariable</assignNextValueToReference>
        <collectionReference>Find_Matching_YCA_Records</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Inactive</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Opportunity_Records_Found</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>Update_Affected_Opportunities</name>
        <label>Update Affected Opportunities</label>
        <locationX>864</locationX>
        <locationY>344</locationY>
        <assignNextValueToReference>LoopVariable_Opportunity</assignNextValueToReference>
        <collectionReference>Get_Affected_Opportunities</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>New_Assumed_Value</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Deactivate</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>Find_Matching_YCA_Records</name>
        <label>Find Matching YCA Records</label>
        <locationX>148</locationX>
        <locationY>386</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Affected_Opportunities</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Active__c</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Cost_Assumption__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_New_YCA_Record.Cost_Assumption__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>Id</field>
            <operator>NotEqualTo</operator>
            <value>
                <elementReference>NewYearlyCostAssumption</elementReference>
            </value>
        </filters>
        <filters>
            <field>Year__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_New_YCA_Record.Year__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>Yearly_Cost_Assumption__c</object>
        <queriedFields>Id</queriedFields>
        <queriedFields>Active__c</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Affected_Opportunities</name>
        <label>Get Affected Opportunities</label>
        <locationX>299</locationX>
        <locationY>491</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>YCA_Records_Found</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Acceptedinto7C__c</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>MIPAContractValueOverride__c</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>MIPASignedDate__c</field>
            <operator>LessThanOrEqualTo</operator>
            <value>
                <elementReference>New_YCA_Effective_End_Date</elementReference>
            </value>
        </filters>
        <filters>
            <field>MIPASignedDate__c</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <elementReference>New_YCA_Effective_Start_Date</elementReference>
            </value>
        </filters>
        <filters>
            <field>TurnkeyValuation__c</field>
            <operator>LessThanOrEqualTo</operator>
            <value>
                <numberValue>0.0</numberValue>
            </value>
        </filters>
        <filters>
            <field>Vertical__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>CostAssumption</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>Opportunity</object>
        <queriedFields>Id</queriedFields>
        <queriedFields>Vertical__c</queriedFields>
        <queriedFields>Assumed_Non_IX_Sales_W__c</queriedFields>
        <queriedFields>MIPA_Contract_Value_Calculation__c</queriedFields>
        <queriedFields>MIPAContractValueOverride__c</queriedFields>
        <queriedFields>Acceptedinto7C__c</queriedFields>
        <queriedFields>Post7CContractAmount__c</queriedFields>
        <queriedFields>TurnkeyValuation__c</queriedFields>
        <queriedFields>EPCRevenue__c</queriedFields>
        <queriedFields>Record_Type_Name__c</queriedFields>
        <queriedFields>ESS_Energy_kWh__c</queriedFields>
        <queriedFields>Original_Contract_System_Size__c</queriedFields>
        <queriedFields>InterconnectionUpgradeCost__c</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_New_YCA_Record</name>
        <label>Get New YCA Record</label>
        <locationX>50</locationX>
        <locationY>236</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Find_Matching_YCA_Records</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>NewYearlyCostAssumption</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Yearly_Cost_Assumption__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Deactivate</name>
        <label>Deactivate</label>
        <locationX>1198</locationX>
        <locationY>217</locationY>
        <connector>
            <targetReference>Update_Assumed_Value</targetReference>
        </connector>
        <inputReference>YCA_RecordsToUpdate</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Assumed_Value</name>
        <label>Update Assumed Value</label>
        <locationX>1308</locationX>
        <locationY>489</locationY>
        <connector>
            <targetReference>Update_New_YCA_Record_Name</targetReference>
        </connector>
        <inputReference>Opportunity_RecordsToUpdate</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_New_YCA_Record_Name</name>
        <label>Update New YCA Name and Active Value</label>
        <locationX>1409</locationX>
        <locationY>92</locationY>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_New_YCA_Record.Id</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>Active_Yearly_Cost_Assumption__c</field>
            <value>
                <elementReference>Get_New_YCA_Record.Cost_Assumption__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Name</field>
            <value>
                <elementReference>New_YCA_Name</elementReference>
            </value>
        </inputAssignments>
        <object>Yearly_Cost_Assumption__c</object>
    </recordUpdates>
    <start>
        <locationX>50</locationX>
        <locationY>50</locationY>
        <connector>
            <targetReference>Get_New_YCA_Record</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <variables>
        <name>CostAssumption</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>LoopVariable</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Yearly_Cost_Assumption__c</objectType>
    </variables>
    <variables>
        <name>LoopVariable_Opportunity</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Opportunity</objectType>
    </variables>
    <variables>
        <name>NewYearlyCostAssumption</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>Opportunity_RecordsToUpdate</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Opportunity</objectType>
    </variables>
    <variables>
        <name>YCA_RecordsToUpdate</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Yearly_Cost_Assumption__c</objectType>
    </variables>
</Flow>
